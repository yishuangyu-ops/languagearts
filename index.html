<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI äº’å‹•è¬›ç¾© V12.0 (å¼·åŠ›å®¹éŒ¯ç‰ˆ)</title>
    <style>
        :root {
            --primary: #2c3e50; --accent: #3498db; --success: #27ae60;
            --bg: #ecf0f1; --card-bg: #ffffff; --text: #34495e;
            --highlight: #fff3cd; --word-hover: #e74c3c;
        }

        body {
            font-family: "Segoe UI", "Microsoft JhengHei", sans-serif;
            background-color: var(--bg); color: var(--text);
            margin: 0; padding: 0; line-height: 1.6;
        }

        nav {
            background: var(--primary); color: white; padding: 15px;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 100;
        }
        .logo { font-size: 1.2rem; font-weight: bold; }
        .mode-switch {
            background: var(--accent); border: none; color: white;
            padding: 8px 15px; border-radius: 20px; cursor: pointer; font-size: 0.9rem;
        }

        .container { max-width: 800px; margin: 20px auto; padding: 0 15px; padding-bottom: 100px; }

        /* è€å¸«å‚™èª²å€ */
        #teacher-zone { display: none; }
        .editor-card {
            background: white; padding: 20px; border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05); margin-bottom: 20px;
        }
        h3 { margin-top: 0; color: var(--primary); border-bottom: 2px solid #eee; padding-bottom: 10px; }
        
        textarea {
            width: 100%; height: 120px; padding: 10px;
            border: 2px solid #bdc3c7; border-radius: 8px;
            margin-bottom: 15px; font-size: 1rem; font-family: monospace;
            resize: vertical;
        }
        textarea:focus { border-color: var(--accent); outline: none; }

        #prompt-preview-area { display: none; background: #f8f9fa; padding: 15px; border-radius: 8px; border: 1px dashed #bdc3c7; margin-bottom: 15px; }
        #prompt-output { background: #e8e8e8; color: #555; border: none; height: 120px; font-size: 0.9rem; }

        .btn-row { display: flex; gap: 10px; flex-wrap: wrap; }
        .action-btn {
            border: none; padding: 10px 20px; border-radius: 5px;
            cursor: pointer; font-size: 1rem; color: white; font-weight: bold;
            transition: transform 0.1s;
        }
        .action-btn:active { transform: scale(0.98); }
        .btn-gen { background: var(--accent); }
        .btn-copy { background: var(--success); }
        .btn-save { background: #e67e22; width: 100%; font-size: 1.2rem; }

        /* å­¸ç”Ÿå­¸ç¿’å€ */
        #student-zone { display: block; }
        .lesson-card {
            background: var(--card-bg); border-radius: 12px;
            margin-bottom: 25px; box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            overflow: hidden; border: 1px solid #eee;
        }
        
        .text-section {
            padding: 25px; cursor: pointer; transition: background 0.2s;
            border-bottom: 1px dashed #eee; position: relative;
        }
        .text-section:hover { background-color: #f7f9f9; }
        .text-section.playing { background-color: #fff9c4; border-left: 6px solid #f1c40f; }
        
        .play-icon { position: absolute; right: 20px; top: 20px; font-size: 1.5rem; opacity: 0.3; }
        .english-text { font-size: 1.4rem; font-weight: 500; color: #2c3e50; margin-bottom: 10px; padding-right: 30px; line-height: 1.6; }
        .chinese-trans { font-size: 1.1rem; color: #7f8c8d; line-height: 1.5; }

        .word-in-text {
            display: inline-block; border-radius: 4px; padding: 0 2px;
            transition: all 0.1s; cursor: pointer;
        }
        .word-in-text:hover { color: var(--word-hover); text-decoration: underline; background: #fae5e5; }

        .analysis-section {
            background: #fafafa; padding: 20px; font-size: 1rem; border-top: 1px solid #eee;
        }
        .analysis-content ul { padding-left: 20px; margin: 5px 0; }
        .analysis-content li { margin-bottom: 8px; }
        .analysis-content b { color: #e67e22; }
        .example-sent { color: #27ae60; font-style: italic; display: block; margin-top: 2px; font-size: 0.9em;}

        .vocab-section { background: #fff; padding: 15px 20px; border-top: 1px dashed #ccc; }
        .section-label { font-size: 0.85rem; color: #95a5a6; font-weight: bold; margin-bottom: 10px; display: block; }
        .vocab-list { display: flex; flex-wrap: wrap; gap: 8px; }
        .vocab-chip { 
            background: #ecf0f1; color: #2c3e50; padding: 5px 12px; border-radius: 20px; 
            font-size: 0.95rem; cursor: pointer; border: 1px solid #bdc3c7; transition: all 0.2s;
            display: flex; align-items: center; gap: 5px;
        }
        .vocab-chip:hover { background: #3498db; color: white; border-color: #3498db; transform: translateY(-2px); }
        .vocab-chip span { font-size: 0.8em; opacity: 0.7; }

        .voice-controls {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background: white; padding: 10px; box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            display: flex; justify-content: center; gap: 10px; z-index: 100;
        }
        select { padding: 5px; border-radius: 5px; border: 1px solid #ccc; max-width: 200px; }

        /* Modal */
        .modal-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 2000; align-items: center; justify-content: center;
        }
        .modal-card {
            background: white; width: 90%; max-width: 400px; padding: 25px;
            border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            position: relative; text-align: center;
        }
        .close-modal { position: absolute; top: 10px; right: 15px; font-size: 1.5rem; cursor: pointer; color: #999; }
        .modal-word { font-size: 2.5rem; font-weight: bold; color: var(--primary); margin: 10px 0; }
        .modal-meaning { font-size: 1.5rem; color: #e67e22; font-weight: bold; margin-bottom: 15px; }
        .modal-example { 
            background: #f0f3f4; padding: 15px; border-radius: 10px; 
            text-align: left; font-size: 1.1rem; color: #555; margin-bottom: 20px;
        }
        .modal-example b { color: var(--primary); }
    </style>
</head>
<body>

<nav>
    <div class="logo">ğŸ“š Smart Lesson V12</div>
    <button class="mode-switch" onclick="toggleMode()">åˆ‡æ›: å‚™èª² / ä¸Šèª²</button>
</nav>

<div class="container">

    <div id="teacher-zone">
        <div class="editor-card">
            <h3>æ­¥é©Ÿ 1: è¼¸å…¥èª²æ–‡</h3>
            <textarea id="raw-text" placeholder="è«‹åœ¨æ­¤è²¼ä¸Šè‹±æ–‡èª²æ–‡..."></textarea>
            <div class="btn-row">
                <button class="action-btn btn-gen" onclick="generatePrompt()">ğŸ§™â€â™‚ï¸ ç”Ÿæˆæ·±åº¦æ•™å­¸æŒ‡ä»¤</button>
            </div>
        </div>

        <div class="editor-card" id="prompt-preview-area">
            <h3>æ­¥é©Ÿ 2: è¤‡è£½æŒ‡ä»¤çµ¦ AI</h3>
            <textarea id="prompt-output" readonly></textarea>
            <div class="btn-row">
                <button class="action-btn btn-copy" onclick="copyPrompt()">ğŸ“‹ è¤‡è£½</button>
                <a href="https://chat.openai.com/" target="_blank" style="margin-left:auto; color:#3498db; text-decoration:none; align-self:center;">å‰å¾€ ChatGPT â†—</a>
            </div>
        </div>

        <div class="editor-card">
            <h3>æ­¥é©Ÿ 3: è²¼ä¸Š AI å›å‚³è³‡æ–™</h3>
            <p style="font-size:0.9rem; color:#666;">
                è«‹å°‡ AI å›å‚³çš„ä»£ç¢¼ (å« [ ... ]) è²¼åœ¨ä¸‹æ–¹ã€‚<br>
                <strong style="color:var(--success)">âœ¨ æ–°å¢åŠŸèƒ½ï¼šç³»çµ±æœƒè‡ªå‹•ä¿®å¾© AI æ ¼å¼éŒ¯èª¤ï¼</strong>
            </p>
            <textarea id="json-input" placeholder='è«‹è²¼ä¸Š [ { ... } ] æ ¼å¼çš„è³‡æ–™' style="height:200px;"></textarea>
            <button class="action-btn btn-save" onclick="saveAndRender()">ğŸ’¾ å„²å­˜ä¸¦é–‹å§‹ä¸Šèª²</button>
        </div>
        
        <div style="text-align:center; margin-top:20px;">
            <button style="background:none; border:none; color:#e74c3c; cursor:pointer; text-decoration:underline;" onclick="resetAll()">æ¸…é™¤é‡ç½®</button>
        </div>
    </div>

    <div id="student-zone">
        <div id="lesson-container">
            <div style="text-align:center; padding: 50px; color:#999;">
                å°šç„¡èª²ç¨‹è³‡æ–™ï¼Œè«‹é»æ“Šå³ä¸Šæ–¹åˆ‡æ›è‡³ã€Œå‚™èª²æ¨¡å¼ã€ã€‚
            </div>
        </div>
    </div>

</div>

<div class="modal-overlay" id="vocab-modal" onclick="closeModal(event)">
    <div class="modal-card">
        <span class="close-modal" onclick="closeModal(event)">Ã—</span>
        <div class="modal-word" id="m-word">Word</div>
        <div class="modal-meaning" id="m-meaning">æ„æ€</div>
        <div class="modal-example" id="m-example">Example sentence.</div>
        <button class="action-btn" style="background:var(--accent); width:100%" onclick="replayVocab()">ğŸ”Š å†å”¸ä¸€æ¬¡</button>
    </div>
</div>

<div class="voice-controls" id="voice-controls" style="display:none;">
    <select id="voiceSelect"></select>
    <button class="action-btn" style="background:#e74c3c; padding:5px 15px;" onclick="stopSpeech()">â¹ åœæ­¢</button>
</div>

<script>
    let lessonData = [];
    const STORAGE_KEY = 'smart_lesson_data_v12';
    const synth = window.speechSynthesis;
    let currentUtterance = null;
    let currentVocabData = null;

    window.onload = function() {
        loadData();
        initVoices();
        if (speechSynthesis.onvoiceschanged !== undefined) {
            speechSynthesis.onvoiceschanged = initVoices;
        }
    };

    function toggleMode() {
        const tZone = document.getElementById('teacher-zone');
        const sZone = document.getElementById('student-zone');
        const vCtrl = document.getElementById('voice-controls');
        
        if (tZone.style.display === 'none') {
            tZone.style.display = 'block';
            sZone.style.display = 'none';
            vCtrl.style.display = 'none';
            stopSpeech();
        } else {
            tZone.style.display = 'none';
            sZone.style.display = 'block';
            vCtrl.style.display = 'flex';
            renderLesson();
        }
    }

    function generatePrompt() {
        const text = document.getElementById('raw-text').value.trim();
        if (!text) return alert("è«‹å…ˆè¼¸å…¥è‹±æ–‡èª²æ–‡ï¼");

        // å„ªåŒ–æŒ‡ä»¤ï¼Œå‘Šè¨´ AI ä¸è¦äº‚æ›è¡Œ
        const prompt = `
ä½ æ˜¯å°ç£åœ‹ä¸­è‹±èªè£œæ•™åå¸«ã€‚è«‹å°‡ä»¥ä¸‹èª²æ–‡æ‹†è§£ç‚ºè©³ç´°çš„ JSON æ•™å­¸è³‡æ–™ã€‚
è«‹åš´æ ¼å›å‚³ä¸€å€‹ç´” JSON Arrayï¼Œä¸è¦ Markdown æ¨™è¨˜ï¼Œä¸è¦åœ¨ JSON å­—ä¸²ä¸­ä½¿ç”¨åæ–œç·šæ›è¡Œ (No line continuation characters)ã€‚

æ ¼å¼å¦‚ä¸‹ï¼š
[
  {
    "english": "è‹±æ–‡æ®µè½åŸæ–‡",
    "chinese": "ä¸­æ–‡ç¿»è­¯",
    "grammar": "è«‹ä½¿ç”¨ HTML (<ul><li><b>) æ’ç‰ˆã€‚å…§å®¹é ˆåŒ…å«ï¼š<br>1. é‡è¦æ–‡æ³•èˆ‡å¥å‹è§£æ<br>2. ç‰‡èªèˆ‡æ…£ç”¨èª (Idioms)<br>3. ä»‹ä¿‚è©ç”¨æ³•<br>4. æ™‚æ…‹èªªæ˜<br>è«‹å‹™å¿…è©³ç›¡è§£é‡‹ï¼Œä¸¦é©æ™‚æä¾›è£œå……ä¾‹å¥ (ç”¨ <span class='example-sent'>ä¾‹å¥</span> åŒ…è£¹)ã€‚",
    "vocab": [
       { "word": "å–®å­—1", "mean": "è©æ€§. ä¸­æ–‡æ„æ€", "ex": "è‹±æ–‡ä¾‹å¥ã€‚" }
    ]
  }
]

è§£èªªè¦æ±‚ï¼š
1. é‡å°å°ç£åœ‹ä¸­ç”Ÿç¨‹åº¦ (Junior High School Level)ã€‚
2. è§£èªªè¦å£èªåŒ–ã€æ¸…æ¥šæ˜ç™½ã€‚
3. æ¯å€‹æ®µè½è‹¥æœ‰ç”Ÿå­—ï¼Œè«‹åˆ—å…¥ vocab é™£åˆ—ä¸­ã€‚

æ–‡ç« å…§å®¹ï¼š
${text}
`;
        document.getElementById('prompt-preview-area').style.display = 'block';
        document.getElementById('prompt-output').value = prompt.trim();
        document.getElementById('prompt-preview-area').scrollIntoView({behavior: "smooth"});
    }

    function copyPrompt() {
        navigator.clipboard.writeText(document.getElementById('prompt-output').value).then(() => {
            alert("æŒ‡ä»¤å·²è¤‡è£½ï¼è«‹è²¼çµ¦ AIã€‚");
        });
    }

    // ==========================================
    // V12.0 æ ¸å¿ƒæ›´æ–°ï¼šå¼·åŠ›æ¸…æ´—èˆ‡é˜²å‘†
    // ==========================================
    function saveAndRender() {
        let inputStr = document.getElementById('json-input').value.trim();
        if(!inputStr) return alert("è«‹è²¼ä¸Šè³‡æ–™ï¼");

        if (inputStr.includes("ä½ æ˜¯å°ç£åœ‹ä¸­è‹±èªè£œæ•™åå¸«")) return alert("â›” è²¼éŒ¯äº†ï¼æ‚¨è²¼åˆ°æŒ‡ä»¤äº†ã€‚");

        try {
            // 1. æŠ“å– JSON å€å¡Š
            const jsonMatch = inputStr.match(/\[\s*\{[\s\S]*\}\s*\]/);
            if (!jsonMatch) throw new Error("æ‰¾ä¸åˆ°æœ‰æ•ˆçš„ JSON çµæ§‹ã€‚");
            
            let cleanJson = jsonMatch[0];

            // 2. ã€é—œéµä¿®å¾©ã€‘ç§»é™¤ AI ç”¢ç”Ÿçš„åæ–œç·šæ›è¡Œç¬¦è™Ÿ
            // é€™è¡ŒæœƒæŠŠ "<ul>\n<li>" è®Šæˆ "<ul><li>"
            cleanJson = cleanJson.replace(/\\\s*(\r\n|\n|\r)/g, "");

            // 3. å˜—è©¦è§£æ
            const data = JSON.parse(cleanJson);
            localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
            lessonData = data;
            
            alert("âœ… æ ¼å¼è‡ªå‹•ä¿®å¾©æˆåŠŸï¼é–‹å§‹ä¸Šèª²ï¼");
            toggleMode(); 
        } catch (e) {
            console.error(e);
            alert("âš ï¸ é‚„æ˜¯è§£æå¤±æ•—ã€‚\nå»ºè­°åšæ³•ï¼šè«‹å‘Šè¨´ AI ã€Œçµ¦æˆ‘ Minified JSON (å£“ç¸®æˆä¸€è¡Œçš„ JSON)ã€é€šå¸¸èƒ½è§£æ±ºæ­¤å•é¡Œã€‚");
        }
    }

    function loadData() {
        const saved = localStorage.getItem(STORAGE_KEY);
        if (saved) {
            try {
                lessonData = JSON.parse(saved);
                renderLesson();
                document.getElementById('teacher-zone').style.display = 'none';
                document.getElementById('student-zone').style.display = 'block';
                document.getElementById('voice-controls').style.display = 'flex';
            } catch(e) {}
        } else {
            document.getElementById('teacher-zone').style.display = 'block';
            document.getElementById('student-zone').style.display = 'none';
        }
    }

    function resetAll() {
        if(confirm("ç¢ºå®šæ¸…é™¤æ‰€æœ‰è³‡æ–™ï¼Ÿ")) {
            localStorage.removeItem(STORAGE_KEY);
            location.reload();
        }
    }

    function renderLesson() {
        const container = document.getElementById('lesson-container');
        container.innerHTML = '';

        if (!lessonData || lessonData.length === 0) return;

        lessonData.forEach((item, index) => {
            const card = document.createElement('div');
            card.className = 'lesson-card';
            
            let vocabHtml = '';
            if (item.vocab && item.vocab.length > 0) {
                const chips = item.vocab.map(v => {
                    const safeWord = escapeJs(v.word);
                    const safeMean = escapeJs(v.mean);
                    const safeEx = escapeJs(v.ex);
                    return `<span class="vocab-chip" onclick="openVocabModal('${safeWord}', '${safeMean}', '${safeEx}')">
                        <b>${v.word}</b> <span>${v.mean.split('.')[0]}</span>
                    </span>`;
                }).join('');
                vocabHtml = `<div class="vocab-section"><span class="section-label">å–®å­—å­¸ç¿’ (é»æ“Šè½ç™¼éŸ³èˆ‡ä¾‹å¥)</span><div class="vocab-list">${chips}</div></div>`;
            }

            const processedEnglish = item.english.split(/([a-zA-Z0-9'-]+)/g).map(chunk => {
                if (/[a-zA-Z0-9'-]+/.test(chunk)) {
                    return `<span class="word-in-text" onclick="playWordSimple(event, '${chunk}')">${chunk}</span>`;
                }
                return chunk;
            }).join('');

            card.innerHTML = `
                <div class="text-section" onclick="playSectionAudio(this, '${escapeJs(item.english)}')">
                    <div class="play-icon">ğŸ”Š</div>
                    <div class="english-text">${processedEnglish}</div>
                    <div class="chinese-trans">${item.chinese}</div>
                </div>
                <div class="analysis-section">
                    <div style="font-weight:bold; color:#2980b9; margin-bottom:10px;">ğŸ’¡ åå¸«è§£æï¼š</div>
                    <div class="analysis-content">${item.grammar || 'ç„¡é‡é»è§£èªª'}</div>
                </div>
                ${vocabHtml}
            `;
            container.appendChild(card);
        });
    }

    function escapeJs(str) {
        if(!str) return "";
        return str.replace(/'/g, "\\'").replace(/"/g, '&quot;').replace(/\n/g, ' ');
    }

    function openVocabModal(word, mean, ex) {
        currentVocabData = { word, ex };
        document.getElementById('m-word').innerText = word;
        document.getElementById('m-meaning').innerText = mean;
        document.getElementById('m-example').innerHTML = `Example: <br><b>${ex}</b>`;
        document.getElementById('vocab-modal').style.display = 'flex';
        stopSpeech();
        speakVocab(word, ex);
    }

    function closeModal(e) {
        if(e.target.id === 'vocab-modal' || e.target.classList.contains('close-modal')) {
            document.getElementById('vocab-modal').style.display = 'none';
            stopSpeech();
        }
    }

    function replayVocab() {
        if(currentVocabData) {
            speakVocab(currentVocabData.word, currentVocabData.ex);
        }
    }

    function speakVocab(word, ex) {
        const u1 = new SpeechSynthesisUtterance(word);
        setVoice(u1);
        u1.rate = 0.8;
        const u2 = new SpeechSynthesisUtterance(ex);
        setVoice(u2);
        u2.rate = 0.9;
        u1.onend = () => { setTimeout(() => synth.speak(u2), 300); };
        synth.speak(u1);
    }

    function initVoices() {
        const select = document.getElementById('voiceSelect');
        const voices = synth.getVoices();
        if(voices.length === 0) return;
        select.innerHTML = '';
        let bestIdx = 0;
        voices.forEach((v, i) => {
            let opt = document.createElement('option');
            opt.value = i;
            opt.text = `${v.name.substring(0, 15)}.. (${v.lang})`;
            select.appendChild(opt);
            if (v.lang === 'en-US' && v.name.includes('Google')) bestIdx = i;
        });
        select.selectedIndex = bestIdx;
    }

    function setVoice(utter) {
        const voices = synth.getVoices();
        const select = document.getElementById('voiceSelect');
        if (voices.length > 0) utter.voice = voices[select.value];
    }

    function playSectionAudio(element, text) {
        stopSpeech();
        element.classList.add('playing');
        const utter = new SpeechSynthesisUtterance(text);
        setVoice(utter);
        utter.rate = 0.9; 
        utter.onend = () => { element.classList.remove('playing'); };
        currentUtterance = utter;
        synth.speak(utter);
    }

    function playWordSimple(event, word) {
        event.stopPropagation();
        stopSpeech();
        const utter = new SpeechSynthesisUtterance(word);
        setVoice(utter);
        utter.rate = 0.8;
        synth.speak(utter);
    }

    function stopSpeech() {
        synth.cancel();
        document.querySelectorAll('.text-section').forEach(el => el.classList.remove('playing'));
    }
</script>
</body>
</html>
