<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI äº’å‹•è¬›ç¾© V10.0 (é»è®€æ——è‰¦ç‰ˆ)</title>
    <style>
        :root {
            --primary: #2c3e50; --accent: #3498db; --success: #27ae60;
            --bg: #ecf0f1; --card-bg: #ffffff; --text: #34495e;
            --highlight: #f1c40f; --word-hover: #e74c3c;
        }

        body {
            font-family: "Segoe UI", "Microsoft JhengHei", sans-serif;
            background-color: var(--bg); color: var(--text);
            margin: 0; padding: 0; line-height: 1.6;
        }

        nav {
            background: var(--primary); color: white; padding: 15px;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 100;
        }
        .logo { font-size: 1.2rem; font-weight: bold; }
        .mode-switch {
            background: var(--accent); border: none; color: white;
            padding: 8px 15px; border-radius: 20px; cursor: pointer; font-size: 0.9rem;
        }

        .container { max-width: 800px; margin: 20px auto; padding: 0 15px; padding-bottom: 100px; }

        /* è€å¸«å‚™èª²å€ */
        #teacher-zone { display: none; }
        .editor-card {
            background: white; padding: 20px; border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05); margin-bottom: 20px;
        }
        h3 { margin-top: 0; color: var(--primary); border-bottom: 2px solid #eee; padding-bottom: 10px; }
        
        textarea {
            width: 100%; height: 120px; padding: 10px;
            border: 2px solid #bdc3c7; border-radius: 8px;
            margin-bottom: 15px; font-size: 1rem; font-family: monospace;
            resize: vertical;
        }
        textarea:focus { border-color: var(--accent); outline: none; }

        #prompt-preview-area { display: none; background: #f8f9fa; padding: 15px; border-radius: 8px; border: 1px dashed #bdc3c7; margin-bottom: 15px; }
        #prompt-output { background: #e8e8e8; color: #555; border: none; height: 100px; font-size: 0.9rem; }

        .btn-row { display: flex; gap: 10px; flex-wrap: wrap; }
        .action-btn {
            border: none; padding: 10px 20px; border-radius: 5px;
            cursor: pointer; font-size: 1rem; color: white; font-weight: bold;
            transition: transform 0.1s;
        }
        .action-btn:active { transform: scale(0.98); }
        .btn-gen { background: var(--accent); }
        .btn-copy { background: var(--success); }
        .btn-save { background: #e67e22; width: 100%; font-size: 1.2rem; }

        /* å­¸ç”Ÿå­¸ç¿’å€ */
        #student-zone { display: block; }
        .lesson-card {
            background: var(--card-bg); border-radius: 12px;
            margin-bottom: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            overflow: hidden; border: 1px solid #eee;
        }
        
        /* èª²æ–‡å€å¡Š */
        .text-section {
            padding: 20px; cursor: pointer; transition: background 0.2s;
            border-bottom: 1px dashed #eee; position: relative;
        }
        .text-section:hover { background-color: #f7f9f9; }
        .text-section.playing { background-color: #fff9c4; border-left: 5px solid #f1c40f; }
        
        .play-icon { position: absolute; right: 20px; top: 20px; font-size: 1.5rem; opacity: 0.3; }
        .english-text { font-size: 1.4rem; font-weight: 500; color: #2c3e50; margin-bottom: 8px; padding-right: 30px; line-height: 1.6; }
        .chinese-trans { font-size: 1rem; color: #7f8c8d; }

        /* å–®å­—äº’å‹•æ¨£å¼ */
        .word {
            display: inline-block;
            border-radius: 4px;
            padding: 0 2px;
            transition: all 0.1s;
            cursor: pointer;
        }
        .word:hover { color: var(--word-hover); text-decoration: underline; }
        .word:active { transform: scale(0.95); background-color: #eee; }

        /* è§£æå€ */
        .analysis-section {
            background: #fafafa; padding: 15px 20px; font-size: 0.95rem; border-top: 1px solid #eee;
        }
        .tag {
            display: inline-block; background: #3498db; color: white;
            padding: 2px 8px; border-radius: 4px; font-size: 0.8rem; margin-right: 5px;
        }
        .vocab-list { margin-top: 10px; display: flex; flex-wrap: wrap; gap: 5px; }
        .vocab-chip { background: #e0e0e0; color: #333; padding: 2px 10px; border-radius: 15px; font-size: 0.85rem; }

        /* èªéŸ³æ§åˆ¶æ¢ */
        .voice-controls {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background: white; padding: 10px; box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            display: flex; justify-content: center; gap: 10px; z-index: 100;
        }
        select { padding: 5px; border-radius: 5px; border: 1px solid #ccc; max-width: 200px; }

        /* å–®å­—ç¿»è­¯å½ˆçª— (Toast) */
        #word-toast {
            position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%);
            background: rgba(44, 62, 80, 0.95); color: white;
            padding: 10px 20px; border-radius: 30px;
            font-size: 1.1rem; box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            z-index: 2000; opacity: 0; pointer-events: none;
            transition: opacity 0.3s, transform 0.3s;
            text-align: center; max-width: 90%; white-space: nowrap;
        }
        #word-toast.show { opacity: 1; transform: translateX(-50%) translateY(-10px); }
        #word-toast strong { color: #f1c40f; margin-right: 10px; }
    </style>
</head>
<body>

<nav>
    <div class="logo">ğŸ“š Smart Lesson V10</div>
    <button class="mode-switch" onclick="toggleMode()">åˆ‡æ›: å‚™èª² / ä¸Šèª²</button>
</nav>

<div class="container">

    <div id="teacher-zone">
        <div class="editor-card">
            <h3>æ­¥é©Ÿ 1: è¼¸å…¥èª²æ–‡</h3>
            <textarea id="raw-text" placeholder="è«‹åœ¨æ­¤è²¼ä¸Šè‹±æ–‡èª²æ–‡..."></textarea>
            <div class="btn-row">
                <button class="action-btn btn-gen" onclick="generatePrompt()">ğŸ§™â€â™‚ï¸ ç”Ÿæˆ AI æŒ‡ä»¤</button>
            </div>
        </div>

        <div class="editor-card" id="prompt-preview-area">
            <h3>æ­¥é©Ÿ 2: è¤‡è£½æŒ‡ä»¤çµ¦ AI</h3>
            <p style="font-size:0.9rem; color:#666;">æŒ‡ä»¤å¦‚ä¸‹ï¼Œè«‹æŒ‰è¤‡è£½ï¼Œè²¼çµ¦ ChatGPTã€‚</p>
            <textarea id="prompt-output" readonly></textarea>
            <div class="btn-row">
                <button class="action-btn btn-copy" onclick="copyPrompt()">ğŸ“‹ è¤‡è£½åˆ°å‰ªè²¼ç°¿</button>
                <a href="https://chat.openai.com/" target="_blank" style="margin-left:auto; color:#3498db; text-decoration:none; align-self:center;">å‰å¾€ ChatGPT â†—</a>
            </div>
        </div>

        <div class="editor-card">
            <h3>æ­¥é©Ÿ 3: è²¼ä¸Š AI å›å‚³è³‡æ–™</h3>
            <p style="font-size:0.9rem; color:#666;">è«‹å°‡ AI å›å‚³çš„ä»£ç¢¼å®Œæ•´è²¼åœ¨ä¸‹æ–¹ (ç³»çµ±æœƒè‡ªå‹•éæ¿¾é›œè¨Š)ã€‚</p>
            <textarea id="json-input" placeholder='è«‹è²¼ä¸Š [ { ... } ] æ ¼å¼çš„è³‡æ–™' style="height:200px;"></textarea>
            <button class="action-btn btn-save" onclick="saveAndRender()">ğŸ’¾ å„²å­˜ä¸¦é–‹å§‹ä¸Šèª²</button>
        </div>
        
        <div style="text-align:center; margin-top:20px;">
            <button style="background:none; border:none; color:#e74c3c; cursor:pointer; text-decoration:underline;" onclick="resetAll()">æ¸…é™¤é‡ç½®</button>
        </div>
    </div>

    <div id="student-zone">
        <div id="lesson-container">
            <div style="text-align:center; padding: 50px; color:#999;">
                å°šç„¡èª²ç¨‹è³‡æ–™ï¼Œè«‹é»æ“Šå³ä¸Šæ–¹åˆ‡æ›è‡³ã€Œå‚™èª²æ¨¡å¼ã€ã€‚
            </div>
        </div>
    </div>

</div>

<div id="word-toast">
    <strong id="toast-word">Word</strong>
    <span id="toast-mean">...</span>
</div>

<div class="voice-controls" id="voice-controls" style="display:none;">
    <select id="voiceSelect"></select>
    <button class="action-btn" style="background:#e74c3c; padding:5px 15px;" onclick="stopSpeech()">â¹ åœæ­¢</button>
</div>

<script>
    let lessonData = [];
    const STORAGE_KEY = 'smart_lesson_data_v10';
    const synth = window.speechSynthesis;
    let currentUtterance = null;

    window.onload = function() {
        loadData();
        initVoices();
        if (speechSynthesis.onvoiceschanged !== undefined) {
            speechSynthesis.onvoiceschanged = initVoices;
        }
    };

    function toggleMode() {
        const tZone = document.getElementById('teacher-zone');
        const sZone = document.getElementById('student-zone');
        const vCtrl = document.getElementById('voice-controls');
        
        if (tZone.style.display === 'none') {
            tZone.style.display = 'block';
            sZone.style.display = 'none';
            vCtrl.style.display = 'none';
            stopSpeech();
        } else {
            tZone.style.display = 'none';
            sZone.style.display = 'block';
            vCtrl.style.display = 'flex';
            renderLesson();
        }
    }

    // ==========================================
    // å‚™èª²èˆ‡è³‡æ–™è™•ç†
    // ==========================================
    function generatePrompt() {
        const text = document.getElementById('raw-text').value.trim();
        if (!text) return alert("è«‹å…ˆè¼¸å…¥è‹±æ–‡èª²æ–‡ï¼");

        const prompt = `
ä½ æ˜¯å°ˆæ¥­è‹±èªæ•™æå°ˆå®¶ã€‚è«‹å°‡ä»¥ä¸‹æ–‡ç« æ‹†è§£ç‚º JSON æ ¼å¼ï¼Œç”¨æ–¼æ•™å­¸è»Ÿé«”ã€‚
è«‹å›å‚³ä¸€å€‹ JSON Arrayï¼Œä¸è¦åŒ…å« markdown æ¨™è¨˜ (å¦‚ \`\`\`json)ï¼Œç›´æ¥å›å‚³ç´”æ–‡å­— JSONã€‚

æ ¼å¼ç¯„æœ¬ï¼š
[
  {
    "english": "è‹±æ–‡æ®µè½åŸæ–‡",
    "chinese": "ä¸­æ–‡ç¿»è­¯",
    "grammar": "<ul><li><b>é‡é»ï¼š</b>èªªæ˜...</li></ul>",
    "vocab": ["å–®å­—1", "å–®å­—2"]
  }
]

è§£èªªè¦æ±‚ï¼š
1. é©åˆé«˜ä¸­/åœ‹ä¸­ç¨‹åº¦ã€‚
2. Grammar æ¬„ä½è«‹ç”¨ HTML <ul> <li> <b> æ’ç‰ˆã€‚
3. è‹¥æœ‰è¤‡é›œå¥å‹è«‹çµ¦ç°¡çŸ­ä¾‹å¥ã€‚

æ–‡ç« å…§å®¹ï¼š
${text}
`;
        document.getElementById('prompt-preview-area').style.display = 'block';
        document.getElementById('prompt-output').value = prompt.trim();
        document.getElementById('prompt-preview-area').scrollIntoView({behavior: "smooth"});
    }

    function copyPrompt() {
        navigator.clipboard.writeText(document.getElementById('prompt-output').value).then(() => {
            alert("æŒ‡ä»¤å·²è¤‡è£½ï¼");
        });
    }

    function saveAndRender() {
        const inputStr = document.getElementById('json-input').value.trim();
        if(!inputStr) return alert("è«‹è²¼ä¸Šè³‡æ–™ï¼");

        if (inputStr.includes("ä½ æ˜¯å°ˆæ¥­è‹±èªæ•™æå°ˆå®¶")) return alert("â›” è²¼éŒ¯äº†ï¼æ‚¨è²¼åˆ°æŒ‡ä»¤äº†ï¼Œè«‹å» ChatGPT è¤‡è£½çµæœã€‚");

        try {
            const jsonMatch = inputStr.match(/\[\s*\{[\s\S]*\}\s*\]/);
            if (!jsonMatch) throw new Error("æ‰¾ä¸åˆ°æœ‰æ•ˆçš„ JSON çµæ§‹ã€‚");

            const data = JSON.parse(jsonMatch[0]);
            localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
            lessonData = data;
            
            alert("âœ… æˆåŠŸç”Ÿæˆï¼");
            toggleMode(); 
        } catch (e) {
            alert("âš ï¸ è§£æå¤±æ•—ï¼Œè«‹ç¢ºèª AI å›å‚³æ ¼å¼æ­£ç¢ºã€‚");
        }
    }

    function loadData() {
        const saved = localStorage.getItem(STORAGE_KEY);
        if (saved) {
            try {
                lessonData = JSON.parse(saved);
                renderLesson();
                document.getElementById('teacher-zone').style.display = 'none';
                document.getElementById('student-zone').style.display = 'block';
                document.getElementById('voice-controls').style.display = 'flex';
            } catch(e) {}
        } else {
            document.getElementById('teacher-zone').style.display = 'block';
            document.getElementById('student-zone').style.display = 'none';
        }
    }

    function resetAll() {
        if(confirm("ç¢ºå®šæ¸…é™¤ï¼Ÿ")) {
            localStorage.removeItem(STORAGE_KEY);
            location.reload();
        }
    }

    // ==========================================
    // æ¸²æŸ“ (V10 æ ¸å¿ƒï¼šå–®å­—åˆ‡å‰²)
    // ==========================================
    function renderLesson() {
        const container = document.getElementById('lesson-container');
        container.innerHTML = '';

        if (!lessonData || lessonData.length === 0) return;

        lessonData.forEach((item, index) => {
            const card = document.createElement('div');
            card.className = 'lesson-card';
            
            // å–®å­— HTML
            let vocabHtml = '';
            if (item.vocab && item.vocab.length > 0) {
                vocabHtml = `<div class="vocab-list">${item.vocab.map(v => `<span class="vocab-chip">${v}</span>`).join('')}</div>`;
            }

            // è™•ç†è‹±æ–‡æ®µè½ï¼šå°‡å–®å­—åˆ‡é–‹
            const processedEnglish = item.english.split(/([a-zA-Z0-9'-]+)/g).map(chunk => {
                if (/[a-zA-Z0-9'-]+/.test(chunk)) {
                    // åŠ å…¥ onclick="playWord"
                    return `<span class="word" onclick="playWord(event, '${chunk}')">${chunk}</span>`;
                }
                return chunk;
            }).join('');

            card.innerHTML = `
                <div class="text-section" onclick="playSectionAudio(this, '${escapeJs(item.english)}')">
                    <div class="play-icon">ğŸ”Š</div>
                    <div class="english-text">${processedEnglish}</div>
                    <div class="chinese-trans">${item.chinese}</div>
                </div>
                <div class="analysis-section">
                    <div class="tag">è§£æ</div>
                    <div style="margin-top:10px;">${item.grammar || 'ç„¡é‡é»è§£èªª'}</div>
                    ${vocabHtml ? `<div style="margin-top:15px; border-top:1px dashed #ccc; padding-top:10px;"><span class="tag" style="background:#e67e22">å–®å­—</span>${vocabHtml}</div>` : ''}
                </div>
            `;
            container.appendChild(card);
        });
    }

    function escapeJs(str) {
        return str.replace(/'/g, "\\'").replace(/"/g, '&quot;');
    }

    // ==========================================
    // èªéŸ³èˆ‡äº’å‹•é‚è¼¯
    // ==========================================
    function initVoices() {
        const select = document.getElementById('voiceSelect');
        const voices = synth.getVoices();
        if(voices.length === 0) return;
        
        select.innerHTML = '';
        let bestIdx = 0;
        voices.forEach((v, i) => {
            let opt = document.createElement('option');
            opt.value = i;
            opt.text = `${v.name.substring(0, 15)}.. (${v.lang})`;
            select.appendChild(opt);
            if (v.lang === 'en-US' && v.name.includes('Google')) bestIdx = i;
        });
        select.selectedIndex = bestIdx;
    }

    // 1. æ’­æ”¾æ•´æ®µ
    function playSectionAudio(element, text) {
        stopSpeech();
        element.classList.add('playing');

        const utter = new SpeechSynthesisUtterance(text);
        setVoice(utter);
        utter.rate = 0.9; 

        utter.onend = () => { element.classList.remove('playing'); };
        currentUtterance = utter;
        synth.speak(utter);
    }

    // 2. æ’­æ”¾å–®å­— (é»æ“Šå–®å­—æ™‚è§¸ç™¼)
    function playWord(event, word) {
        // é—œéµï¼šé˜»æ­¢äº‹ä»¶å†’æ³¡ (Stop Propagation)ï¼Œé˜²æ­¢è§¸ç™¼æ•´æ®µæœ—è®€
        event.stopPropagation();
        
        // åœæ­¢ç›®å‰çš„æœ—è®€
        stopSpeech();

        // æœ—è®€å–®å­—
        const utter = new SpeechSynthesisUtterance(word);
        setVoice(utter);
        utter.rate = 0.8; // å–®å­—å”¸æ…¢ä¸€é»
        synth.speak(utter);

        // æŸ¥è©¢å–®å­—æ„æ€
        showWordToast(word);
    }

    function setVoice(utter) {
        const voices = synth.getVoices();
        const select = document.getElementById('voiceSelect');
        if (voices.length > 0) utter.voice = voices[select.value];
    }

    function stopSpeech() {
        synth.cancel();
        document.querySelectorAll('.text-section').forEach(el => el.classList.remove('playing'));
    }

    // 3. é¡¯ç¤ºå–®å­—ç¿»è­¯
    async function showWordToast(word) {
        const toast = document.getElementById('word-toast');
        const tWord = document.querySelector('#word-toast strong');
        const tMean = document.querySelector('#word-toast span');
        
        tWord.innerText = word;
        tMean.innerText = "æŸ¥è©¢ä¸­...";
        toast.classList.add('show');
        
        try {
            const res = await fetch(`https://api.mymemory.translated.net/get?q=${encodeURIComponent(word)}&langpair=en|zh-TW`);
            const data = await res.json();
            if (data.responseData) {
                // æ¸…ç†ç¿»è­¯çµæœ (å»é™¤æ¨™é»)
                tMean.innerText = data.responseData.translatedText.replace(/[!.ã€‚]/g, "");
            } else {
                tMean.innerText = "æŸ¥ç„¡çµæœ";
            }
        } catch (e) {
            tMean.innerText = "ç¶²è·¯éŒ¯èª¤";
        }

        // 3ç§’å¾Œæ¶ˆå¤±
        setTimeout(() => {
            toast.classList.remove('show');
        }, 3000);
    }
</script>
</body>
</html>
